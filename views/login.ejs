<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/login.css">
    <script src="https://accounts.google.com/gsi/client" async></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <title>Login | Iskolar ni Simeon</title>
</head>
<body>
  <div class="modal fade" id="termsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="termsModalLabel">Terms and Conditions</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%- include("partials/tac.ejs") %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="understoodBtn">Understood</button>
        </div>
      </div>
    </div>
  </div>

  <div class="outer-container">
    <div id="background">
      <img src="/images/inswhite.svg" alt="Logo" draggable="false">
      <p class="backgroundtitle montserrat-800">Iskolar ni Simeon</p>
      <p class="backgroundsubtitle montserrat-400">
        <span>From </span> <span>GJCians,</span> <span>to </span> <span>GJCians.</span>
      </p>
    </div>
    <div id="login">
      <img src="/images/inswhite.svg" alt="Logo" draggable="false">
      <h1 class="montserrat-800 logintitle"></h1>
      <div id="buttonDiv" class="signin" data-bs-toggle="modal"></div>
      <% if (isLibraryPort) { %>
        <div class="divider">
          <span class="divider-text">or</span>
        </div>
        <button class="guest-btn" id="guest">Continue as guest</button>
        <% } %>
        <div id="loader" class="loader">
          <div class="check"></div>
          <div class="error-x"></div>
        </div>
      <div id="loaderText" class="loader-text">Logging in...</div>
      <div class="footer">
        <p class="montserrat-400 verse"><i>"Let us not become weary in doing good, for at the proper time we will reap a harvest if we do not give up"</i> <br> <i><b>- Galatians 6:9</b></i></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const words = document.querySelectorAll('.backgroundsubtitle span');
        words.forEach((word, index) => {
            word.style.animationDelay = `${index * 0.1}s`;
        });
    });
  </script>

<script defer>
document.addEventListener("DOMContentLoaded", function() {
  var signin = document.getElementsByClassName("signin")[0];
  var loader = document.getElementById("loader");
  var divider = document.querySelector(".divider");
  var guestBtn = document.querySelector(".guest-btn");
  var loaderTimeout;
  var understood = document.getElementById("understoodBtn");

  function hideLoginElements() {
    signin.style.opacity = "0";
    signin.style.visibility = "hidden";
    loader.style.opacity = "1";
    loader.style.visibility = "visible";
  }

  function showLoginElements() {
    signin.style.opacity = "1";
    signin.style.visibility = "visible";
    loader.style.opacity = "0";
    loader.style.visibility = "hidden";
  }

  function handleCredentialResponse(response) {
    var termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
    termsModal.show();

    understood.disabled = true;
    understood.innerText = "Read the Terms and Conditions first.";
    var termsContent = document.getElementById("termsModal").getElementsByClassName("modal-body")[0];
    
    termsContent.onscroll = function() {
      if ((termsContent.scrollTop + termsContent.clientHeight) >= termsContent.scrollHeight - 1) {
        console.log('Scroll reached bottom');
        understood.innerText = "I Understand";
        understood.disabled = false;
      }
    }

    understood.onclick = function() {
      console.log('Terms accepted, beginning login process...');
      termsModal.hide();
      hideLoginElements();
      document.getElementById("loaderText").style.visibility = "visible";

      console.time("Total Login Time");
      console.log('Login payload:', {
        credential: response.credential.substring(0, 20) + '...', // Log partial credential for security
        clientId: response.clientId
      });
      
      fetch("<%= server_api %>/login", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Origin': "<%= origin %>",
          'Access-Control-Allow-Origin': '*'
        },
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify({ 
          'credential': response.credential, 
          'clientId': response.clientId 
        }),
      })
      .then(response => {
        console.timeEnd("Total Login Time");
        console.log("Server response status:", response.status);
        console.log("Response headers:", Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          return response.text().then(text => {
            console.error("Server error response:", text);
            throw new Error(`Server error: ${response.status} - ${text || response.statusText}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log("Login response successful:", {
          userId: data.token.sub,
          name: data.token.given_name,
          savedThesesCount: data.saved?.data?.length || 0
        });
        
        console.log("Setting up session...");
        localStorage.setItem('savedTheses', JSON.stringify(data.saved.data.map(thesis => thesis.id || [])));
        
        return fetch('/auth/setup-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            jwtToken: data.jwtToken,
            userId: data.token.sub,
            name: data.token.given_name,
            email: data.token.email,
            picture: data.token.picture,
          })
        });
      })
      .then(res => {
        console.log("Session setup response:", res.status);
        if (res.ok) {
          console.log("Session setup successful");
          showSuccess("Successfully logged in!");
        } else {
          throw new Error("Failed to setup session");
        }
      })
      .catch(error => {
        console.error("Login process error:", error);
        console.error("Full error details:", {
          message: error.message,
          stack: error.stack,
          online: navigator.onLine,
          origin: window.location.origin
        });
        
        if (!navigator.onLine) {
          showError("You appear to be offline. Please check your internet connection.");
        } else if (error.message.includes("Failed to fetch")) {
          showError(`Cannot reach server at ${window.location.origin}. Please try again later.`);
        } else {
          showError(error.message || "Login failed. Please try again.");
        }
      });
    }
  }

  function showSuccess(message) {
    loader.classList.remove('error');
    loader.classList.add('success');
    document.getElementById("loaderText").style.display = "block";
    document.getElementById("loaderText").textContent = message;
    
    setTimeout(() => {
      loader.classList.remove('success');
      loader.classList.add('redirect');
      const loaderText = document.getElementById("loaderText");
      loaderText.textContent = "Redirecting...";
      
      setTimeout(() => {
        location.replace('/');
      }, 1000);
    }, 1500);
  }

  function showError(error) {
    loader.classList.remove('success');
    loader.classList.add('error');
    document.getElementById("loaderText").style.display = "block";
    document.getElementById("loaderText").innerHTML = `
      <div>Login error:</div>
      <small class="text-white-50">${error}</small>
      <div class="mt-2">
        <button onclick="resetLoader()" class="btn btn-sm btn-outline-light">Try Again</button>
      </div>`;
  }

  function resetLoader() {
    setTimeout(() => {
      showLoginElements();
      loader.classList.remove('success', 'error');
      document.getElementById("loaderText").style.display = "none";
    }, 500);
  }

  window.onload = function () {
    google.accounts.id.initialize({
      client_id: '<%= oauthid %>',
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("buttonDiv"),
      { theme: "outline", size: "large", text: "signin", shape: "pill", locale: "us_en"}
    );
    google.accounts.id.prompt();
  }
});
</script>
<% if (isLibraryPort) { %>
  <script>
    var signin = document.getElementsByClassName("signin")[0];
    var loader = document.getElementById("loader");
    var divider = document.querySelector(".divider");
    var guestBtn = document.querySelector(".guest-btn");
    var loaderTimeout;
    var understood = document.getElementById("understoodBtn");

    function hideLoginElements() {
      signin.style.display = "none";
      loader.style.display = "none";
      divider.style.display = "none";
      guestBtn.style.display = "none";

    }

    function showLoginElements() {
      signin.style.display = "block";
      loader.style.display = "none";
      divider.style.display = "block";
      guestBtn.style.display = "block";
    }

    guestBtn.addEventListener('click', () => {
      hideLoginElements();
      loader.style.display = "block";
      document.getElementById("loaderText").style.display = "block";
      loader.classList.add('success');
      document.getElementById("loaderText").textContent = "Continuing as guest...";
      setTimeout(() => {
        location.replace('/');
      }, 1500);
    })

    async function guestApi() {
      try {
        const response = await fetch('<%= server_api %>/guest-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': "<%= guest_api_key %>"
          },
          credentials: 'include',
          mode: 'cors',
          body: JSON.stringify({
            signInAs: 'guest'
          })
        });

        if (!response.ok) {
          throw new Error(`Guest API error: ${response.status} - ${response.statusText}`);
        }
        return response.json();
      } catch (error) {
        console.error("Guest API error:", error);
        showError("Failed to continue as guest. Please try again.");
      }
    }

    async function setupSession(data) {
      try {
        const response = await fetch('/auth/setup-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            jwtToken: data.jwtToken,
            userId: data.token.sub,
            name: data.token.given_name,
            picture: data.token.picture,
          })
        });

        if (!response.ok) {
          throw new Error("Failed to setup session");
        }
      } catch (error) {
        console.error("Session setup error:", error);
        showError("Failed to setup session. Please try again.");
      }
    }

    guestBtn.addEventListener('click', () => {
      hideLoginElements();
      loader.style.display = "block";
      document.getElementById("loaderText").style.display = "block";
      loader.classList.add('success');
      document.getElementById("loaderText").textContent = "Continuing as guest...";
      guestApi()
        .then(data => {
          console.log("Guest login response:", data);
          return setupSession(data);
        })
        .then(() => {
          showSuccess("Successfully logged in as guest!");
        })
        .catch(error => {
          console.error("Guest login error:", error);
          showError("Failed to continue as guest. Please try again.");
        });
    });
  </script>
  <% }%>
</body>
</html>
